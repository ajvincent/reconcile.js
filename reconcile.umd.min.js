'use strict';Object.defineProperty(exports, '__esModule', {value:true});exports.diff = diff;exports.isEqualChange = isEqualChange;exports.patch = patch;exports.sortChangeset = sortChangeset;exports.apply = apply;function _classCallCheck(instance, Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function');}}var ChangeSet=function ChangeSet(){_classCallCheck(this, ChangeSet);};exports.ChangeSet = ChangeSet;function mapElements(nodes, includeReverse){var map={};var tags={};var node;var indices=[];for(var i=0, len=nodes.length; i < len; i++) {node = nodes[i];var id=node.id?node.id:generateId(node, tags);map[id] = node;node._i = i;node._id = id;indices.push(i);}return {'map':map, 'indices':indices};}function generateId(node, tags){var tag=node.tagName?node.tagName:'x' + node.nodeType;if(!tags[tag]){tags[tag] = 0;}tags[tag]++;return tag + tags[tag];}function generateMoves(map, nodes, indices, base, reverse, index){var moves=[];var compare=[];var operateMap={};var tags={};for(var i=0, len=nodes.length; i < len; i++) {var node=nodes[reverse?nodes.length - i - 1:i], bound=base.childNodes[reverse?base.childNodes.length - indices[i] - 1:indices[i]], id=node.id?node.id:generateId(node, tags);if(operateMap[id]){return;}var existing=map[id];if(existing){if(existing !== bound){var relativeBaseIndex=reverse?base.childNodes.length - existing._i - 1:existing._i;moves.push({'action':'moveChildElement', 'element':existing, 'baseIndex':index + '>' + relativeBaseIndex, 'sourceIndex':index + '>' + i});indices.splice(i, 0, indices.splice(relativeBaseIndex, 1)[0]);}if(!node.isEqualNode(existing)){compare.push([node, existing]);}}else {var inserted=node.cloneNode(true);var relativeBaseIndex=reverse?nodes.length - i - 1:i;moves.push({'action':'insertChildElement', 'element':inserted, 'baseIndex':index + '>' + relativeBaseIndex, 'sourceIndex':index + '>' + relativeBaseIndex});}operateMap[id] = true;}for(var i=0, len=base.childNodes.length; i < len; i++) {var remove=base.childNodes[i];var removeId=remove._id;if(!operateMap[removeId]){moves.push({'action':'removeChildElement', 'element':remove, 'baseIndex':index + '>' + remove._i, 'sourceIndex':null});}}return {'compare':compare, 'diff':moves};};function diff(source, base, index){var diffActions=[];if(source.isEqualNode(base)){return diffActions;}if(typeof index === 'undefined'){index = '0';}if(source.nodeType === 3 && base.nodeType === 3){if(base.nodeValue !== source.nodeValue){diffActions.push({'action':'replaceText', 'element':base, 'baseIndex':index, 'sourceIndex':index, '_deleted':base.nodeValue, '_inserted':source.nodeValue});}return diffActions;}if(source.attributes && base.attributes){var attributes=source.attributes, value, name;for(var i=0, len=attributes.length; i < len; i++) {value = attributes[i].nodeValue;name = attributes[i].nodeName;var val=base.getAttribute(name);if(val !== value){if(val === null){diffActions.push({'action':'setAttribute', 'name':name, 'element':base, 'baseIndex':index, 'sourceIndex':index, '_inserted':value});}else {diffActions.push({'action':'setAttribute', 'name':name, 'element':base, 'baseIndex':index, 'sourceIndex':index, '_deleted':val, '_inserted':value});}}}attributes = base.attributes;for(var i=0, len=attributes.length; i < len; i++) {name = attributes[i].nodeName;if(source.getAttribute(name) === null){diffActions.push({'action':'removeAttribute', 'name':name, 'baseIndex':index, 'sourceIndex':index, '_deleted':base.getAttribute(name)});}}}var compare=[];if(source.childNodes && base.childNodes){var mapResult=mapElements(base.childNodes, true), nodes=source.childNodes;var map=mapResult['map'];var indices=mapResult['indices'];var moves=generateMoves(map, nodes, indices.slice(0), base, false, index);if(moves['diff'].length > 1){var backwardMoves=generateMoves(map, nodes, indices.slice(0), base, true, index);if(backwardMoves['diff'].length < moves['diff'].length){moves = backwardMoves;}}diffActions = diffActions.concat(moves['diff']);compare = moves['compare'];}if(compare.length > 0){for(var i=0, len=compare.length; i < len; i++) {var sourceChildNode=compare[i][0];var baseChildNode=compare[i][1];var childDiffs=diff(sourceChildNode, baseChildNode, index + '>' + baseChildNode._i);if(childDiffs.length > 0){diffActions = diffActions.concat(childDiffs);}delete baseChildNode._i;delete baseChildNode._id;}}return diffActions;}function isEqualChange(change1, change2){return change1['baseIndex'] === change2['baseIndex'] && change1['sourceIndex'] === change2['sourceIndex'] && change1['action'] === change2['action'] && change1['name'] === change2['name'] && change1['_deleted'] === change2['_deleted'] && change1['_inserted'] === change2['_inserted'] && change1['element'].isEqualNode(change2['element']);}function patch(theirs, mine){var conflicts=[];var changes=[];var theirChanges=theirs.slice(0);var myChanges=mine.slice(0);for(var i=0, len=theirChanges.length; i < len; i++) {var theirItem=theirChanges[i];var myItem, m=0, myLength=myChanges.length;for(; m < myLength; m++) {myItem = myChanges[m];if(theirItem['baseIndex'] === myItem['baseIndex']){if(isEqualChange(theirItem, myItem)){changes.push(myItem);}else {theirItem['_conflict'] = true;theirItem['_owner'] = 'theirs';myItem['_conflict'] = true;myItem['_owner'] = 'mine';conflicts.push(theirItem);conflicts.push(myItem);}break;}myItem = null;}if(!myItem){changes.push(theirItem);}else {myChanges.splice(m, 1);}}if(myChanges.length > 0){changes = changes.concat(myChanges);}if(conflicts.length > 0){changes = changes.concat(conflicts);}changes.sort(sortChangeset);return changes;}function sortChangeset(a, b){if(a['sourceIndex'] === b['sourceIndex']){return 0;}else if(!a['sourceIndex'] && b['sourceIndex']){return -1;}else if(a['sourceIndex'] && !b['sourceIndex']){return 1;}var aIndices=a['sourceIndex'].split('>');var bIndices=b['sourceIndex'].split('>');var equal=true;var i=0;while(equal && i < aIndices.length && i < bIndices.length) {var aN=parseInt(aIndices[i], 10);var bN=parseInt(bIndices[i], 10);if(aN === bN){i++;continue;}else if(isNaN(aN) || isNaN(bN)){return isNaN(aN)?1:-1;}else {return aN > bN?1:-1;}}return 0;}function apply(changes, base){var unapplied=[];var moves=[];var removals=[];var conflictNodes=[];for(var c=0, cLen=changes.length; c < cLen; c++) {var change=changes[c];var action=change['action'];var baseIndex=change['baseIndex'];var sourceIndex=change['sourceIndex'];var node=base;var baseItemIndices=baseIndex.split('>');for(var i=1, len=baseItemIndices.length; i < len; i++) {var nodeIndex=parseInt(baseItemIndices[i], 10);if(node.childNodes && node.childNodes.length > nodeIndex){node = node.childNodes[nodeIndex];}else {if(action === 'insertChildElement'){moves.push([node, change['element'], null, change]);}else {unapplied.push(change);}node = null;break;}}if(node === null){continue;}if(action === 'moveChildElement' || action === 'insertChildElement'){var sourceNode=base;var sourceItemIndices=sourceIndex.split('>');for(var i=1, len=sourceItemIndices.length; i < len; i++) {var nodeIndex=parseInt(sourceItemIndices[i], 10);if(sourceNode.childNodes && sourceNode.childNodes.length > nodeIndex){sourceNode = sourceNode.childNodes[nodeIndex];}else {sourceNode = null;break;}}if(action === 'moveChildElement'){moves.push([node.parentNode, node, sourceNode, change]);}else {if(sourceNode === null){moves.push([node.parentNode, change['element'], null, change]);}else {moves.push([node.parentNode, change['element'], sourceNode, change]);}}}else if(action === 'removeChildElement'){removals.push([node.parentNode, node]);}else if(!change['_conflict']){if(action === 'replaceText'){node.nodeValue = change['_inserted'];}else if(action === 'setAttribute'){node.setAttribute(change['name'], change['_inserted']);}else if(action === 'removeAttribute'){node.removeAttribute(change['name']);}}else {node['_conflict_' + change['_owner']] = change['_inserted'];if(conflictNodes.indexOf(node) < 0){conflictNodes.push(node);}}}moves.sort(function(a, b){return sortChangeset(a[3], b[3]);});for(var i=0, len=moves.length; i < len; i++) {var move=moves[i];var parent=move[0], insertion=move[1], source=move[2], change=move[3];if(change['_conflict']){var conflictNode=document.createElement(change['_owner']);conflictNode.appendChild(insertion);conflictNodes.push(conflictNode);insertion = conflictNode;}parent.insertBefore(insertion, source);}for(var i=0; i < removals.length; i++) {var removal=removals[i];removal[0].removeChild(removal[1]);}return {'unapplied':unapplied, 'conflicts':conflictNodes};}

